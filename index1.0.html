<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
          "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<title>Blokus</title>
    <link rel="stylesheet" type="text/css" href="styles/style.css"></link>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.5.0/jquery.min.js"></script>
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.9/jquery-ui.min.js"></script>
	<script type="text/javascript" src="pieces.js"></script>
	<script>
		//TODO: full board is 20x20!
		var GameArray = {};
		var PlayerId = 1;
		var gameX;
		var gameY;
		var SizeX = 34;
		var SizeY = 34;
		$(init);

		function init(){
			GameArray = generateGameBoard(20, 20);
			PlayerId = 1;
			$("#gameGrid")
				.droppable( {
					      accept: '.gamePiece',
					      hoverClass: 'hovered',
					      drop: handlePieceDrop});
			gameX = $("#gameGrid").offset().left;
			gameY = $("#gameGrid").offset().top;
			
			generateGamePieces();
		}

		function generateGameBoard(x, y){
			var board = [];
			var state = [];

			for(var i = 0; i < y; i++)
			{
				var gameRow = [];
				state[i] = [];
				var $tr = $("<tr></tr>");
				for(var j = 0; j < x; j++)
				{
					gameRow.push(
						$("<td></td>", {class:"cell"})
						.data("x", j)
						.data("y", i)
						.appendTo($tr));
					state[i][j] = 0;
				}
				$tr.appendTo($("#gameGrid"));
				board.push(gameRow);
			}

			return {"html":board, "state":state};
		}

		function handlePieceDrop(event, ui){
			var $gamePiece = ui.draggable;
		    var offsetY = ui.offset.top;
		    var offsetX = ui.offset.left;
		    var coords = getCoordinates(offsetX, offsetY, $gamePiece);

		    var validationResult = validateMove(GameArray, $gamePiece, coords.x, coords.y, PlayerId);
		    if(validationResult == true)
	    	{
		    	//$gamePiece.draggable( 'disable' );
	   		    applyPiece(coords.x, coords.y, $gamePiece);
	   		}
			else
			{
				//TODO
			}
		}

		function validateMove(gameArray, $piece, x, y, playerId)
		{
			var isValid = true;
			var pieceY = $piece.find("tr").length;
			var pieceX = $piece.find("tr").first().find("td").length;
			//TODO
			//Condition 1: piece fits completely on game board
			if(x < 0 || y < 0 ||
				gameArray.state.length < y + pieceY ||
				gameArray.state[0].length < x + pieceX)
			{
				isValid = false;
			}

			//Condition 2: doesn't overlap other blocks
			if(isValid)
			{
				for(var i = 0; i < pieceY; i++)
				{
					if(isValid)
					{
						for(var j = 0; j < pieceX; j++)
						{
							if(gameArray.state[y + i][x + j] !== 0)
							{
								isValid = false;
								break;
							}
						}
					}
				}
			}
			//Condition 3: doesn't have same colored blocks adjacent
			if(isValid)
			{

			}


			//Condition 4: must touch same colored block diagonally at least once
			return isValid;
		}

		function applyPiece(x, y, $piece){			
			var pieceData = GamePieces[$piece.data("pid")];
			for(var i = 0; i < pieceData.length; i++)
			{
				for(var j = 0; j < pieceData[i].length; j++)
				{
					if(pieceData[i][j] == 1)
					{
						GameArray.html[y + i][x + j].addClass("coloredCell").removeClass("cell");
						GameArray.state[y + i][x + j] = PlayerId;
					}
				}
			}
			
			$piece.remove();
		}

		function getCoordinates(x, y, $piece){
			var dx = x - gameX;
			var dy = y - gameY;
			var pid = $piece.data("pid");


			var xCoord = Math.floor(( dx + (SizeX / 2) ) / SizeX);
			var yCoord = Math.floor(( dy + (SizeY / 2) ) / SizeY);

			return {"x": xCoord, "y": yCoord};
		}

		function generateGamePieces(){
			for(var pid = 0; pid < GamePieces.length; pid++)
			{
				var $piece = {div: getNewGamePiece()};
				
				fillPieceTable($piece.children('table'), pid);

				$piece.data("pid", h);

				$("<div></div>", {class:"gamePieceContainer"})
					.append($piece)
					.appendTo($("#pieceCollection"));		
			}
		}

		function flipPiece($piece){
			var $rotated = $("<table cellspacing=\"0\"></table>");
			var pid = $piece.data("pid");
			var oldPiece = GamePieces[pid];
			var newPiece = [];
			for(var i = 0; i < oldPiece.length; i++)
				{
					newPiece[i] = [];
					for(var j = 0; j < oldPiece[0].length; j++)
					{
						newPiece[i][j] = oldPiece[i][oldPiece[0].length - 1 - j];
					}
				}
			GamePieces[pid] = newPiece;
			fillPieceTable($piece.children("table"), pid);
		}

		function rotatePiece($piece){
			var $rotated = $("<table cellspacing=\"0\"></table>");
			var pid = $piece.data("pid");
			var oldPiece = GamePieces[pid];
			var newPiece = [];
			for(var i = 0; i < oldPiece[0].length; i++)
				{
					newPiece[i] = [];
					for(var j = 0; j < oldPiece.length; j++)
					{
						newPiece[i][j] = oldPiece[j][oldPiece[0].length - 1 - i];
					}
				}
			GamePieces[pid] = newPiece;
			fillPieceTable($piece.children("table"), pid);
		}

		function getNewGamePiece(){
			var $rotateButton = $("<a></a>",{class:"rotateButton"})
				.click(function(){
					rotatePiece($(this).parent());
				})
				.hide();

			var $flipButton = $("<a></a>",{class:"flipButton"})
				.click(function(){
					flipPiece($(this).parent());
				})
				.hide();

			var $piece = $("<div></div>", {class:"gamePiece"})
				.hover(
					//hover handler:
					function(){
						$(this).children(".rotateButton").show();
						$(this).children(".flipButton").show();
					},
					//un-hover handler:
					function(){
						$(this).children(".rotateButton").hide();
						$(this).children(".flipButton").hide();
					})
				.draggable({
					start:function(){
						$(this).children(".rotateButton").hide();
						$(this).children(".flipButton").hide();
					},
					stack:'.gamePiece',
					revert: true})
				.append($("<table cellspacing=\"0\"></table>"))
				.append($rotateButton)
				.append($flipButton);
			return $piece;
		}

		function fillPieceTable($table, pid){
			var thisPiece = GamePieces[pid];
			var maxWidth = 0;
			
			$table.children().remove();

			for(var i = 0; i < thisPiece.length; i++)
			{
				maxWidth = thisPiece[i].length > maxWidth ? thisPiece[i].length : maxWidth;
			}

			for(var i = 0; i < thisPiece.length; i++)
			{
				var $tr = $("<tr></tr>");
				for(var j = 0; j < maxWidth; j++)
				{
					if(thisPiece[i][j] == 1)
					{
						$tr.append($("<td></td>",{class:"coloredCell"}).data("set",true));
					}
					else
					{
						$tr.append($("<td></td>",{class:"whiteCell"}).data("set",false));
					}
				}
				$tr.appendTo($table);
			}
		}
	</script>
</head>
<body>
	<div id="gameContainer">
		<table id="gameGrid" cellspacing="0">
		</table>
		<span class="spacer"></span>
		<div id="pieceCollection">
		</div>
	</div>
</body>
</html>